# 기능 요구사항 및 엣지 케이스

## 기능 요구사항 (Functional Requirements)

### 1. 번역 시스템 (Translation System)

#### FR-1.1: 다국어 소스 지원
- **요구사항**: 영어 localization 파일을 한국어로 번역
- **입력 형식**: YAML 형식의 `*_l_english.yml` 파일
- **출력 형식**: YAML 형식의 `___*_l_korean.yml` 파일
- **지원 게임**: CK3, Victoria 3, Stellaris

#### FR-1.2: AI 기반 번역
- **요구사항**: Google Gemini AI를 사용한 맥락 인식 번역
- **모델**: gemini-flash-lite-latest (1차), gemini-flash-latest (2차 폴백)
- **재시도 메커니즘**: 실패 시 자동 재시도
- **타임아웃**: 기본 120초, 최대 600초

#### FR-1.3: 게임별 맥락 프롬프트
- **CK3**: 중세 시대, 봉건제, 역사적 인물/지명
- **VIC3**: 19-20세기, 산업화, 정치/경제 용어
- **Stellaris**: SF, 우주 탐험, 외계 종족/기술

### 2. 캐싱 시스템 (Caching System)

#### FR-2.1: 컨텐츠 기반 해싱
- **알고리즘**: xxHash64
- **목적**: 소스 텍스트 변경 감지
- **저장소**: SQLite (LibSQL) 데이터베이스

#### FR-2.2: 다층 캐시
- **1단계**: Dictionary (즉시 반환)
- **2단계**: Cache (데이터베이스 조회)
- **3단계**: AI Translation (API 호출)

#### FR-2.3: 게임별 네임스페이스
- **CK3**: 프리픽스 없음 (하위 호환성)
- **VIC3**: `vic3:` 프리픽스
- **Stellaris**: `stellaris:` 프리픽스

### 3. Upstream 관리 (Upstream Management)

#### FR-3.1: Git 저장소 동기화
- **방식**: Sparse checkout + Partial clone
- **최적화**: 필요한 localization 파일만 다운로드
- **버전 관리**: 최신 태그 또는 기본 브랜치

#### FR-3.2: 병렬 처리
- **요구사항**: 여러 모드 저장소 동시 업데이트
- **타임아웃**: 개별 저장소당 적용
- **에러 핸들링**: 부분 실패 허용

### 4. 검증 시스템 (Validation System)

#### FR-4.1: 게임 변수 보존
- **패턴**: `$var$`, `[GetTitle]`, `@icon!`, `£currency£`, `#bold#`
- **검증**: 원본의 모든 변수가 번역에도 존재
- **구조 정규화**: 문자열 리터럴 제외 비교

#### FR-4.2: 기술 식별자 보존
- **패턴**: `snake_case` (예: `mod_icon_special`)
- **규칙**: 기술 식별자는 번역하지 않음

#### FR-4.3: 한글 포함 검증
- **규칙**: 게임 변수 내부에 한글 금지
- **예**: `[GetTitle]` (올바름) vs `[Get제목]` (오류)

#### FR-4.4: 불필요한 응답 필터링
- **패턴**: "네, 알겠습니다", "Yes, I understand" 등
- **처리**: 검증 실패로 표시하여 재번역 트리거

#### FR-4.5: 잘못된 변수 구문 감지
- **패턴**: `$[`, `£[`, `@[`, `[$` 등
- **목적**: AI가 변수 구문을 혼합하는 버그 방지

### 5. 사전 시스템 (Dictionary System)

#### FR-5.1: 게임별 사전
- **구조**: `Record<string, string>` (키-값 쌍)
- **대소문자**: 무시 (정규화)
- **우선순위**: 모든 캐시보다 높음

#### FR-5.2: 사전 무효화
- **트리거**: 사전 업데이트 시 (`pnpm ck3:update-dict`)
- **범위**: 사전 키를 포함한 모든 번역
- **동작**: 캐시 제거 및 해시 null 설정

#### FR-5.3: 번역 메모리
- **용도**: AI 프롬프트에 포함
- **형식**: `"key" → "translation"` 목록
- **효과**: AI의 일관된 번역 가이드

### 6. 파일 처리 (File Processing)

#### FR-6.1: YAML 파싱
- **인코딩**: UTF-8 with BOM
- **구조**: `l_english: { key: ["text", "hash"] }`
- **주석**: 해시 값 보존

#### FR-6.2: 파일명 규칙
- **입력**: `*_l_english.yml`
- **출력**: `___*_l_korean.yml`
- **접두사**: `___` (로드 순서 제어)

#### FR-6.3: 디렉토리 구조
- **소스**: `upstream/Mod/localization/english/`
- **출력**: `mod/localization/korean/`
- **Replace**: `mod/localization/korean/replace/` (선택사항)

### 7. 설정 관리 (Configuration Management)

#### FR-7.1: meta.toml 파싱
- **필수 필드**: `upstream.localization`, `upstream.language`
- **선택 필드**: `upstream.url`
- **형식**: TOML

#### FR-7.2: 환경 변수
- **필수**: `GOOGLE_AI_STUDIO_TOKEN`
- **형식**: `.env` 파일 또는 환경 변수

### 8. 로깅 시스템 (Logging System)

#### FR-8.1: 로그 레벨
- **debug**: 상세 디버깅 정보
- **verbose**: 처리 상세 로그
- **info**: 일반 정보
- **warn**: 경고
- **error**: 에러

#### FR-8.2: 진행 상황 추적
- **시작**: 작업 시작 알림
- **진행**: 항목별 처리 로그
- **완료**: 통계 및 성공 메시지

## 엣지 케이스 (Edge Cases)

### 1. 번역 관련 엣지 케이스

#### EC-1.1: 빈 문자열
- **입력**: `key: ""`
- **처리**: 번역 건너뛰기
- **출력**: 원본 그대로 유지

#### EC-1.2: 특수 문자만 포함
- **입력**: `key: "!!!"`
- **처리**: AI 번역 시도
- **검증**: 특수 문자 보존 확인

#### EC-1.3: 매우 긴 텍스트
- **입력**: 8192+ 토큰 텍스트
- **처리**: API 제한 초과 가능
- **대응**: 청크 분할 (향후 구현) 또는 에러

#### EC-1.4: 중첩된 게임 변수
- **입력**: `[Select_CString(Concatenate('a', GetName), 'b')]`
- **처리**: 구조 정규화 후 검증
- **검증**: 전체 구조 보존 확인

#### EC-1.5: 이스케이프된 따옴표
- **입력**: `He said \"hello\"`
- **처리**: 따옴표 이스케이프 유지
- **출력**: `그가 \"안녕\"이라고 말했습니다`

#### EC-1.6: 혼합 언어
- **입력**: `The duke (공작)`
- **처리**: AI가 판단하여 번역
- **검증**: 변수가 아닌 경우 통과

#### EC-1.7: 동일 해시, 다른 텍스트 (해시 충돌)
- **확률**: 극히 낮음 (xxHash64)
- **처리**: 해시 일치 시 기존 번역 사용
- **영향**: 드물지만 잘못된 번역 가능

### 2. 캐싱 관련 엣지 케이스

#### EC-2.1: 캐시 데이터베이스 손상
- **증상**: `database is malformed`
- **처리**: 에러 로그 출력
- **복구**: 캐시 재생성 필요 (수동)

#### EC-2.2: 동시 접근 (Database Locked)
- **원인**: 여러 프로세스가 동시 실행
- **처리**: SQLite WAL 모드로 일부 완화
- **대응**: 재시도 또는 수동 종료

#### EC-2.3: 디스크 공간 부족
- **증상**: `ENOSPC`
- **처리**: 에러로 중단
- **대응**: 공간 확보 후 재실행

#### EC-2.4: 캐시 크기 증가
- **원인**: 삭제된 항목 공간 미회수
- **처리**: 정상 동작하지만 파일 커짐
- **대응**: `VACUUM` 실행 (수동)

### 3. Upstream 관련 엣지 케이스

#### EC-3.1: 저장소 없음 (404)
- **증상**: `repository not found`
- **처리**: 에러 로그 출력 및 중단
- **대응**: meta.toml URL 수정

#### EC-3.2: 네트워크 타임아웃
- **원인**: 느린 네트워크 또는 큰 저장소
- **처리**: Git 타임아웃으로 실패
- **대응**: 재시도 또는 네트워크 확인

#### EC-3.3: 태그와 브랜치 모두 없음
- **상황**: 빈 저장소
- **처리**: 최신 커밋 체크아웃 시도
- **실패 시**: 에러 처리

#### EC-3.4: Sparse checkout 경로 불일치
- **원인**: meta.toml 경로가 저장소에 없음
- **결과**: 빈 디렉토리
- **처리**: "소스 디렉토리 없음" 경고

#### EC-3.5: Git 인증 필요
- **상황**: Private 저장소
- **처리**: SSH 키 또는 토큰 필요
- **제한**: 현재 HTTPS 공개 저장소만 지원

### 4. 검증 관련 엣지 케이스

#### EC-4.1: 변수 반복
- **입력**: `The [GetTitle] and [GetTitle]`
- **번역**: `[GetTitle]과(와) [GetTitle]`
- **검증**: 통과 (반복 허용)

#### EC-4.2: 변수 순서 변경
- **입력**: `[A] and [B]`
- **번역**: `[B]과(와) [A]`
- **검증**: 통과 (순서 무관)

#### EC-4.3: 문자열 리터럴 내 번역
- **입력**: `[Concatenate(' or ', GetName)]`
- **번역**: `[Concatenate(' 혹은 ', GetName)]`
- **검증**: 통과 (리터럴 번역 허용)

#### EC-4.4: 거짓 양성 - 괄호 텍스트
- **입력**: `The title (duke)`
- **번역**: `직함 (공작)`
- **검증**: 통과 (변수가 아님)

#### EC-4.5: 복합 패턴
- **입력**: `$var$ and [GetTitle]`
- **번역**: `$var$와(과) [GetTitle]`
- **검증**: 모든 변수 보존 확인

### 5. 파일 시스템 관련 엣지 케이스

#### EC-5.1: 파일명 특수 문자
- **입력**: `file name (special).yml`
- **처리**: 파일 시스템이 허용하면 처리
- **제한**: OS별 파일명 제한 적용

#### EC-5.2: 긴 경로
- **상황**: 260자 초과 (Windows)
- **처리**: OS별 경로 길이 제한
- **실패**: 경로 오류

#### EC-5.3: 읽기 전용 파일
- **증상**: `EACCES`
- **처리**: 권한 에러로 중단
- **대응**: 권한 변경 필요

#### EC-5.4: 심볼릭 링크
- **처리**: Node.js가 자동 해결
- **제한**: 순환 링크는 에러

#### EC-5.5: Replace 폴더 누락
- **상황**: `replace/english` 없음
- **처리**: 경고 로그, 계속 진행
- **결과**: Replace 출력 없음

### 6. AI API 관련 엣지 케이스

#### EC-6.1: API 할당량 초과
- **증상**: `429 Too Many Requests`
- **처리**: 에러로 중단
- **대응**: 대기 후 재시도

#### EC-6.2: API 키 무효
- **증상**: `401 Unauthorized`
- **처리**: 즉시 중단
- **대응**: 유효한 키 설정

#### EC-6.3: 응답 타임아웃
- **설정**: 요청별 타임아웃
- **처리**: 재시도 (최대 2회)
- **실패**: 해당 항목 건너뛰기

#### EC-6.4: 빈 응답
- **증상**: AI가 빈 문자열 반환
- **처리**: 검증 실패
- **대응**: 재번역 필요

#### EC-6.5: JSON 파싱 오류
- **원인**: AI 응답 형식 오류
- **처리**: 에러 로그
- **대응**: 재시도

### 7. 동시성 관련 엣지 케이스

#### EC-7.1: 병렬 번역 충돌
- **상황**: 여러 파일이 같은 캐시 접근
- **처리**: SQLite WAL 모드로 해결
- **제한**: 동시 쓰기는 순차 처리

#### EC-7.2: 프로세스 중단
- **원인**: Ctrl+C 또는 시스템 종료
- **상태**: 부분 완료
- **복구**: 재실행 시 중단 지점부터 계속

#### EC-7.3: 메모리 부족
- **증상**: `heap out of memory`
- **원인**: 대량 파일 동시 처리
- **대응**: 힙 크기 증가 또는 배치 크기 조정

### 8. 설정 관련 엣지 케이스

#### EC-8.1: meta.toml 없음
- **처리**: 해당 모드 건너뛰기
- **로그**: 파일 없음 메시지

#### EC-8.2: meta.toml 구문 오류
- **증상**: TOML 파싱 실패
- **처리**: 에러로 중단
- **대응**: 구문 수정

#### EC-8.3: 필수 필드 누락
- **예**: `localization` 필드 없음
- **처리**: 에러로 중단
- **대응**: 필드 추가

#### EC-8.4: 빈 localization 배열
- **입력**: `localization = []`
- **처리**: 작업 없이 완료
- **로그**: 경로 없음 메시지

#### EC-8.5: 중복 경로
- **입력**: `localization = ["path", "path"]`
- **처리**: 두 번 처리 (비효율)
- **영향**: 결과는 동일

### 9. 인코딩 관련 엣지 케이스

#### EC-9.1: BOM 없는 파일
- **처리**: 자동으로 BOM 추가
- **호환성**: 게임 엔진 요구사항

#### EC-9.2: 다른 인코딩 (UTF-16, ISO-8859-1)
- **처리**: UTF-8로 읽기 시도
- **실패**: 깨진 문자 가능
- **제한**: UTF-8 전용

#### EC-9.3: 이모지 포함
- **입력**: `"Hello 👋"`
- **처리**: 정상 처리
- **출력**: 이모지 보존

### 10. 버전 관리 관련 엣지 케이스

#### EC-10.1: 게임 버전 변경
- **상황**: 게임 업데이트로 파일 구조 변경
- **처리**: 새 구조로 자동 처리
- **실패**: 경로 불일치 시 에러

#### EC-10.2: 모드 버전 변경
- **상황**: 모드가 대규모 업데이트
- **처리**: 해시 불일치로 재번역
- **결과**: 변경된 항목만 업데이트

#### EC-10.3: 사전 버전 충돌
- **상황**: 사전 업데이트 후 기존 번역과 불일치
- **처리**: 사전 무효화로 해결
- **명령**: `pnpm ck3:update-dict`

## 비기능 요구사항 (Non-Functional Requirements)

### NFR-1: 성능
- **초기 번역**: 10,000 항목 기준 10-30분
- **증분 번역**: 100 변경 항목 기준 1-5분
- **캐시 히트율**: 95%+ (2차 실행 이후)

### NFR-2: 안정성
- **API 재시도**: 최대 2회
- **부분 실패**: 계속 진행 (일부 실패 허용)
- **데이터 무결성**: 캐시 손상 시 재생성 가능

### NFR-3: 확장성
- **새 게임 추가**: 코드 수정 최소화
- **새 모드 추가**: 설정 파일만으로 가능
- **사전 확장**: 코드 수정 없이 추가 가능

### NFR-4: 유지보수성
- **코드 구조**: 모듈화된 컴포넌트
- **문서화**: 종합 문서 제공
- **로깅**: 상세한 처리 로그

### NFR-5: 보안
- **API 키**: 환경 변수로 관리
- **Git 저장소**: HTTPS만 지원
- **입력 검증**: 파일 경로 검증

### NFR-6: 호환성
- **Node.js**: v18+
- **OS**: Windows, macOS, Linux
- **게임**: CK3, VIC3, Stellaris (현재)

## 제한사항 (Limitations)

### L-1: 기술적 제한
- **AI 모델**: Google Gemini만 지원
- **소스 언어**: 영어만 지원
- **타겟 언어**: 한국어만 지원
- **파일 형식**: YAML만 지원

### L-2: 성능 제한
- **API 속도**: 구글 서버에 의존
- **동시 요청**: 명시적 제한 없음 (큐 관리)
- **파일 크기**: 메모리 제한 내

### L-3: 기능 제한
- **오프라인**: 부분적으로만 가능 (캐시된 항목)
- **실시간 번역**: 배치 처리만 지원
- **GUI**: CLI만 제공

### L-4: 품질 제한
- **AI 오류**: 100% 정확도 보장 불가
- **검증 규칙**: 모든 오류 감지 불가
- **맥락 이해**: AI 모델 한계

## 참고 사항

### 문서 관련
- **아키텍처**: [architecture.md](architecture.md)
- **번역 파이프라인**: [translation-pipeline.md](translation-pipeline.md)
- **검증 시스템**: [validation.md](validation.md)
- **캐싱 시스템**: [caching.md](caching.md)
- **트러블슈팅**: [troubleshooting.md](troubleshooting.md)

### 이슈 제보
엣지 케이스를 발견하거나 새로운 요구사항이 있으면 GitHub Issues에 제보해주세요.

---

**최종 업데이트:** 2025-10-12
